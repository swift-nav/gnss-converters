sudo: required
dist: trusty

language: c

git:
  submodules: false

matrix:
  include:
    - os: linux
      addons:
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main'
              key_url: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
            - ubuntu-toolchain-r-test
          packages:
            - g++-6
            - check
      env: GCCVER=6 TESTENV=gcc6
    - os: linux
      addons:
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main'
              key_url: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
            - ubuntu-toolchain-r-test
          packages:
            - g++-6
            - check
            - lcov
      env: GCCVER=6 TESTENV=codecov
    - os: linux
      env: TESTENV=stack

cache:
  apt: true
  directories:
    - $HOME/.stack/

before_install:
  # Install stack and the required libsbp library
  - if [[ "$TESTENV" == "stack" ]]; then
      mkdir -p $HOME/.local/bin $HOME/.local/include $HOME/.local/lib;
      export PATH=~/.local/bin:$PATH;
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/.local/lib;
      travis_retry curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack';
      git clone https://github.com/swift-nav/libsbp.git;
      mkdir libsbp/c/build;
      cd libsbp/c/build;
      cmake ../;
      sudo make install;
      cd ../../../;
    fi
  - if [[ "$TESTENV" != "stack" ]]; then
      export CC=gcc-$GCCVER;
      export CXX=g++-$GCCVER;
      export C_COMPILER=$CC;
      export CXX_COMPILER=$CXX;
      $CC --version;
      $CXX --version;
      git submodule update --init --recursive;
    fi

after_success:
  if [[ "$TESTENV" == "codecov" ]]; then
    bash <(curl -s https://codecov.io/bash) -s c/build || echo "Codecov did not collect coverage reports";
  fi

script:
  - bash ./travis.sh
