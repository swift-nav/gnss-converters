# yamllint disable rule:line-length
---
sudo: required
dist: trusty

language: c

git:
  submodules: false

matrix:
  include:

    - os: linux
      addons:
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main'
              key_url: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
            - ubuntu-toolchain-r-test
          packages:
            - g++-6
      env: GCCVER=6 TESTENV=gcc6

    - os: linux
      addons:
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main'
              key_url: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
            - ubuntu-toolchain-r-test
          packages:
            - g++-6
            - lcov
      env: GCCVER=6 TESTENV=codecov

    - os: linux
      env: TESTENV=stack

    - os: linux
      language: rust
      rust: nightly
      addons:
        apt:
          sources:
            - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-6.0 main'
              key_url: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
            - ubuntu-toolchain-r-test
          packages:
            - clang-6.0
      env: TESTENV=rust CC=clang-6.0 CXX=clang++-6.0

    - os: osx
      osx_image: xcode8
      language: rust
      rust: nightly
      env: TESTENV=rust CC=clang CXX=clang++

    - os: windows
      language: rust
      rust: nightly-x86_64-pc-windows-gnu
      env:
        - TESTENV=rust
        - CMAKE_GENERATOR="MinGW Makefiles"
        - CC=gcc
        - CXX=g++

cache:
  apt: true
  directories:
    - $HOME/.stack/

before_install:
  # Install stack and the required libsbp library
  - if [[ "$TESTENV" == "stack" ]]; then
      mkdir -p $HOME/.local/bin $HOME/.local/include $HOME/.local/lib;
      export PATH=~/.local/bin:$PATH;
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$HOME/.local/lib;
      travis_retry curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack';
      git clone https://github.com/swift-nav/libsbp.git;
      mkdir libsbp/c/build;
      cd libsbp/c/build;
      cmake ../;
      sudo make install;
      cd ../../../;
    fi
  - if [[ "$TESTENV" == "codecov" ]] || [[ "$TESTENV" == "gcc6" ]]; then
      export CC=gcc-$GCCVER;
      export CXX=g++-$GCCVER;
      export C_COMPILER=$CC;
      export CXX_COMPILER=$CXX;
      $CC --version;
      $CXX --version;
      git submodule update --init --recursive;
    fi
  - if [[ "$TESTENV" == "rust" ]]; then
      export C_COMPILER=$CC;
      export CXX_COMPILER=$CXX;
      $CC --version;
      $CXX --version;
      git submodule update --init --recursive;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      choco uninstall -y mingw;
      choco install -y --no-progress mingw --version=6.4.0;
    fi

after_success:
  if [[ "$TESTENV" == "codecov" ]]; then
    bash <(curl -s https://codecov.io/bash) -s c/build || echo "Codecov did not collect coverage reports";
  fi

before_script:
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then rm "C:/Program Files/Git/usr/bin/sh.exe"; fi

script:
  - bash ./travis.sh
  - if [[ "$TESTENV" == "rust" ]] && [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      cd target/release;
      7z a -tzip ../../gnss_converters_windows.zip rtcm3tosbp.exe sbp2rtcm.exe ubx2sbp.exe;
      cd ../..;
      VERSION="$(git describe --always --tags --dirty)";
      BUILD_TRIPLET="$($CC -dumpmachine)";
      mv gnss_converters_windows.zip "gnss_converters-${VERSION}-windows-${BUILD_TRIPLET}.zip";
      ls -l;
    fi
  - if [[ "$TESTENV" == "rust" ]] && [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      tar -C "target/release" -czf gnss_converters_osx.tar.gz rtcm3tosbp sbp2rtcm ubx2sbp;
      VERSION="$(git describe --always --tags --dirty)";
      BUILD_TRIPLET="$($CC -dumpmachine)";
      mv gnss_converters_osx.tar.gz "gnss_converters-${VERSION}-${BUILD_TRIPLET}.tar.gz";
      ls -l;
    fi
  - if [[ "$TESTENV" == "rust" ]] && [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      tar -C "target/release" -czf gnss_converters_linux.tar.gz rtcm3tosbp sbp2rtcm ubx2sbp;
      VERSION="$(git describe --always --tags --dirty)";
      BUILD_TRIPLET="$($CC -dumpmachine)";
      mv gnss_converters_linux.tar.gz "gnss_converters-${VERSION}-${BUILD_TRIPLET}.tar.gz";
      ls -l;
    fi

_github_api_key: &_github_api_key
  api_key:
    secure: "rt7J8tM6aoAGikRmoE1asqjmGIHyQsVc83Lu16mLhmV6vvvbE9pFCI7tVU/OXbE/KgDs2pEo4BE6Y5FbZXTMk7OmQ/ejrP28YyOQsWCOulxeALY6KjSp3vu1Z8wxtzxNIf6utUl3eWmQSv1N/Z9vOVm7tzLxDSR1a2gCFIwNJuPgV5rQ96MNMEKy8baa0Xus3Omfnlw0EeaAi7FgLEs06Th58VB3OCmaWvN3PP9c2zBGnRGli0KHThamxLbv1MN+rppr6LufE+V0zTqn0QoU+OBUFHGK4TjjiSSWkGi43cGqSK/ufwbtummx9AAVA6f0aDT4DiqSdV6vmhE2Cj7NkfF6Rck9VfrlCc8AgjQQ6bohMejCDHI78cjTBDegvNtJp8OtORKUQIon5HCUR2mrdC8B8snF4p0sqgr1E3TAMhqzew256Nd24Yf5q0kYVF2M4c3zD+bkwFvMoM4Eu0Mhg91/tF7GaAfuvZ/1YECBQ4hSaJBrsttW6Ie8hI2HCXykcCl3qI1/sag5D1yGX6ffNNTojoj1vj2F6islO6p+l1Dbg3Y2xqKOrwJ47y3MBM18FJ4C0rl6arFNU7xPISaZWDkD9urTh6qpYlbsoQ3+w9LP1+ofzTf1SfW4oIVHYFxAacppQub6DnjVBxuINHVJ8kGutGEDox+NXWrBL9m/M7g="

deploy:
  - provider: releases
    file_glob: true
    file: "gnss_converters-*windows*.zip"
    skip_cleanup: true
    "on":
      tags: true
      condition: "$TRAVIS_OS_NAME = windows"
    <<: *_github_api_key
  - provider: releases
    file_glob: true
    file: "gnss_converters-*darwin*.tar.gz"
    skip_cleanup: true
    "on":
      tags: true
      condition: "$TRAVIS_OS_NAME = osx"
    <<: *_github_api_key
  - provider: releases
    file_glob: true
    file: "gnss_converters-*linux*.tar.gz"
    skip_cleanup: true
    "on":
      tags: true
      condition: "$TRAVIS_OS_NAME = linux"
    <<: *_github_api_key
...
